server:
  port: 8000

spring:
  application:
    name: gateway
  config:
    import: 'optional:consul:'
  cloud:
    consul:
      enabled: true
      discovery:
        # Get only services that are passing the health check
        query-passing: true
      host: ${SPRING_CLOUD_CONSUL_HOST:localhost}
      port: 8500
      config:
        prefixes:
          - config
        format: YAML
        default-context: application
        watch:
          enabled: true
          delay: 3000
          wait-time: 5
    gateway:
      server:
        webflux:
          routes:
            - id: multiplication
              uri: lb://multiplication/
              predicates:
                - Path=/challenges/**,/attempts/**,/users/**
            - id: gamification
              uri: lb://gamification/
              predicates:
                - Path=/leaders
          globalcors:
            cors-configurations:
              '[/**]':
                allowedOrigins: "http://localhost:3000"
                allowedHeaders:
                  - "*"
                allowedMethods:
                  - "GET"
                  - "POST"
                  - "PUT"
                  - "DELETE"
                  - "OPTIONS"
                exposedHeaders:
                  - "Authorization"
                allowCredentials: true
          default-filters:
            - TokenRelay
            - name: Retry
              args:
                retries: 3
                methods: GET,POST
          observability:
            enabled: true
          #httpserver:
            #wiretap: true
          #httpclient:
            #wiretap: true
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8180/realms/microservices-demo
          jwk-set-uri: http://${KEYCLOAK_HOST:localhost}:8180/realms/microservices-demo/protocol/openid-connect/certs
  reactor:
    context-propagation: auto
##working with default logback configuration for distributed tracing
logging:
  pattern:
    level: "[${spring.application.name:-},%X{traceId:-},%X{spanId:-}] "
  include-application-name: false
  level:
    #reactor.netty: DEBUG
    org.springframework.cloud.gateway.handler.predicate: trace
    #io.micrometer: TRACE

management:
  tracing:
    sampling:
      probability: 1.0
    export:
      enabled: true
      zipkin:
        endpoint: http://${SPRING_CLOUD_ZIPKIN_HOST:localhost}:9411/api/v2/spans

---
spring:
  config:
    activate:
      on-profile: docker
  cloud:
    gateway:
      server:
        webflux:
          globalcors:
            cors-configurations:
              '[/**]':
                allowedOrigins:
                 - "http://challenges-frontend:3000"
                 - "http://localhost:3000"
                allowedHeaders:
                  - "*"
                allowedMethods:
                  - "GET"
                  - "POST"
                  - "PUT"
                  - "DELETE"
                  - "OPTIONS"
                exposedHeaders:
                  - "Authorization"
                allowCredentials: true

---
spring:
  config:
    activate:
      on-profile: kubernetes
  cloud:
    gateway:
      server:
        webflux:
          globalcors:
            cors-configurations:
              '[/**]':
                allowedOrigins:
                 - "http://challenges-frontend"
                 - "http://microservices.local"
                 - "http://localhost"
                 - "http://localhost:3000"
                allowedHeaders:
                  - "*"
                allowedMethods:
                  - "GET"
                  - "POST"
                  - "PUT"
                  - "DELETE"
                  - "OPTIONS"
                exposedHeaders:
                  - "Authorization"
                allowCredentials: true
  #with ingress using localhost/auth for k8s profile
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost/auth/realms/microservices-demo
          jwk-set-uri: http://keycloak:8180/auth/realms/microservices-demo/protocol/openid-connect/certs